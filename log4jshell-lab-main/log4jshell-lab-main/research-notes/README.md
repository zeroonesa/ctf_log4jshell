# Remote Code Execution (RCE) in Apache Log4j2 - Log4Shell

I wanted to learn more about the recent Log4j vulnerabilities, and even got asked to replicate some of the initial variations shared publicly. Creating a proof-of-concept was not as easy as I thought, because I was not as familiar with Log4j. I wanted to get a better understanding of the implementation of JNDI lookups in Log4j. However, I did not even know what Log4j was ðŸ˜‚. Therefore, I started to read Log4j documentation from [https://logging.apache.org/log4j/2.x/index.html](https://logging.apache.org/log4j/2.x/index.html) and took several notes over a couple of days.

The following sections highlight initial docs that helped me a lot to get more familiarized with the technology and concepts behind `Log4Shell`. I am cleaning my research notes and sharing them here so that others can benefit if possible.

## Research Notes

* Understanding the Implementation of Technology
  * [2021-12-10_01 Log4j Overview](2021-12-10_01-log4j-overview.md)

## Affected Versions:
| Date | CVE | Versions |
| --- | --- | --- |
| 2021-12-10 | [CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228) | 2.0-beta9 to 2.14.1 |
| 2021-12-14 | [CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228), [CVE-2021-45046](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046) | 2.0-beta9 to 2.15.0-rc |
| 2021-12-16 | [CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228), [CVE-2021-45046](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046), [CVE-2021-45105](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45105) | 2.0-Alpha1 - 2.16|

## Research Timeline

Having a timeline was and is still very useful to understand how we got here and explain some of the features that have been removed and added to the Log4j framework.

| Date | Event | Additional Details |
| --- | --- | --- |
| 2012-02-26 | [Log4j rewrite (Log4j 2.0)](https://blogs.apache.org/logging/entry/log4j_2_is_on_the) | <ul><li>Log4j 2.0 is moved to the main trunk of Log4j</li><li>Complete rewrite of Log4j</li></ul> |
| 2012-07-29 | [Log4j 2.0-alpha1 released!](https://logging.apache.org/log4j/2.x/changes-report.html#a2.0-alpha1) | <ul><li>Property Support - Properties can be referenced in the configuration and either be directly replace or passed to the underlying component where they can be dynamically resolved.</li><li>Properties can come from values defined in the configuration file, system properties, environment variables, the ThreadContext Map, and data present in the event. Users can further customize the property providers by adding their own `Lookup` Plugin</li></ul>|
| 2013-07-17 | [LOG4J2-313 created](https://issues.apache.org/jira/browse/LOG4J2-313) | <ul><li>JNDILookup plugin proposed by Woonsan.</li><li>[JNDI Lookup plugin patch](https://issues.apache.org/jira/secure/attachment/12592850/jndi-lookup-plugin.patch) shared by Woonsan.
| 2013-09-14 | [Log4j 2.0-beta9 released!](https://logging.apache.org/log4j/2.x/changes-report.html#a2.0-beta9) | <ul><li>2013-09-21 - [Release announcement](https://blogs.apache.org/logging/entry/apache_log4j_2_0_beta9)</li><li>[New Feature - LOG4J2-313](https://issues.apache.org/jira/browse/LOG4J2-313) - New JNDILookup plugin was added to this release.</li></ul> |
| 2014-11-25 | [LOG4J2-905 created](https://issues.apache.org/jira/browse/LOG4J2-905) | <ul><li>User created issue to have the ability to disable (date) lookup completely.</li><li>Issue was created due to compatibility issues with [CAMEL SIMPLE language](https://camel.apache.org/components/next/languages/simple-language.html).</li></ul>
| 2016-08-04 | [BlackHat Preentation: JNDI Injection](https://www.youtube.com/watch?v=Y8a5nB-vy78) | <ul><li>Alvaro MuÃ±oz (@pwntester - Principal Security Researcher, HPE Fortify</li><li>Oleksandr Mirosh -Senior QA Engineer, HPE Fortify</li><li>[Slide Deck](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)</li></ul> |
| 2016-08-18 | [LOG4J2-905 follow up](https://issues.apache.org/jira/browse/LOG4J2-905) | <ul><li>Suggestions to provide/document a way to disable lookups.</li><li>Make the distinction between lookups being used in `configuration files` and in `messages`.</li><li>Naming idea: `%msg{nolookups}`.</li><ul>|
| 2016-10-02 | [Log4j 2.7 released!](https://logging.apache.org/log4j/2.x/changes-report.html#a2.7) | <ul><li>2016-10-07 - [Release announcement](https://blogs.apache.org/logging/entry/log4j_2_7_released).</li><li>[Fixed Bug - LOG4J2-905](https://issues.apache.org/jira/browse/LOG4J2-905) - Ability to disable message lookup via layout message format pattern: `%msg{nolookup}`.</li><li>**Message lookup is still enabled by default**.</li><ul>|
| 2017-11-09 | [LOG4J2-2109](https://issues.apache.org/jira/browse/LOG4J2-2109) | <ul><li> Issue created to request the creation of a property to disable message pattern converter lookups globally.</li><li>The `log4j.formatMsgNoLookups` property switch is proposed. This is the equivalent to defining all message patterns using `%msg{nolookups}`. This allows applications to globally disable message pattern from looking up replacements.</li><li>**Message lookup is still enabled by default**.</li></ul>|
| 2017-11-18 | [Log4j 2.10 released!](https://logging.apache.org/log4j/2.x/changes-report.html#a2.10.0) | <ul><li>2017-11-23 - [Release announcement](https://blogs.apache.org/logging/entry/log4j-2-10-released).</li><li>[New Feature - LOG4J2-2109](https://issues.apache.org/jira/browse/LOG4J2-2109) - Add property to disable message pattern converter lookups.</li></ul>|
| 2020-11-06 | [Log4j 2.14.0 Released!](https://logging.apache.org/log4j/2.x/changes-report.html#a2.14.0)| <ul><li>2020-11-11 - [Release announcement](https://blogs.apache.org/logging/entry/log4j-2-14-0-released)</li></ul>|
| 2021-11-29 | [LOG4J2-3198](https://issues.apache.org/jira/browse/LOG4J2-3198) | <ul><li> Issue created to disable Message lookups by default</li></ul>|
| 2021-12-05 | [LOG4J2-3201](https://issues.apache.org/jira/browse/LOG4J2-3201) | <ul><li>Issue opened to limit the protocols JNDI can use by default. Limit the servers and classes that can be accessed via LDAP.</li></ul>|
| 2021-12-09 | [LOG4J2-3202](https://issues.apache.org/jira/browse/LOG4J2-3202) | <ul><li>Issue created to only allow lookups in message, not in parameters.</li><li>This is resolved in 2.15.0 release. Duplicate of [LOG4J2-3198](https://issues.apache.org/jira/browse/LOG4J2-3198).</li></ul> |
| 2021-12-09 | [CVE-2021-44228 published](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228) | <ul><li> Apache Log4j2 JNDI features do not protect against attacker controlled LDAP and other JNDI related endpoints.</li><li>Affected Log4j versions: Log4j2 2.0-beta9 through 2.12.1 and 2.13.0 through 2.15.0</li><li>An attacker who can control log messages or log message parameters can execute arbitrary code loaded from LDAP servers when message lookup substitution is enabled.</li><li>Log4j 1.x does not have Lookups so the risk is lower. Applications using Log4j 1.x are only vulnerable to this attack when they use JNDI in their configuration. A separate CVE (CVE-2021-4104) has been filed for this vulnerability.</li></ul>.
| 2021-12-10 | [Log4j 2.15.0 released!](https://logging.apache.org/log4j/2.x/changes-report.html#a2.15.0) | <ul><li>[New Feature LOG4J2-3198](https://issues.apache.org/jira/browse/LOG4J2-3198) - Pattern layout no longer enables lookups within message text by default for cleaner API boundaries and reduced formatting overhead.</li><li>The old `log4j2.formatMsgNoLookups` which disabled lookups within messages has been removed as well as the `nolookups` message pattern converter option.</li><li>`log4j2.formatMsgNoLookups` system property was removed.</li><li>**Pattern layout no longer enables lookups within message text by defaul**.</li><li>**The old behavior can be enabled on a per-pattern basis using `%m{lookups}`**.</li><li>[CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228) addressed by **disabling lookups withing messages by default**.</li></ul>|
| 2021-12-11 | [LOG4J2-3208](https://issues.apache.org/jira/browse/LOG4J2-3208) | <ul><li>Proposal to completely disable JNDI by default. Those who are will need to specify `-Dlog4j2.enableJndi=true` or the environment variable form of it to use any JNDI components.</li><li>Setting environment variable `LOG4J_FORMAT_MSG_NO_LOOKUPS=true` is NOT a recommended measure any more.</li><li>The only valid mitigation is upgrading to Log4j 2.16.0+ or removing the JndiLookup class from the log4j-core JAR. Any release other than 2.16.0, you may remove the JndiLookup class</li></ul>|
| 2021-12-13 | [LOG4J2-3211](https://issues.apache.org/jira/browse/LOG4J2-3211) | <ul><li>Issue created to remove support for Lookups in messages</li><li>Log a message if either the lookup or nolookup option is specified on %m. Remove calls to StrSubstitutor.replace().</li></ul>|
| 2021-12-13 | [Log4j 2.16.0 released!](https://logging.apache.org/log4j/2.x/changes-report.html#a2.16.0) | <ul><li>[Bug Fixed - LOG4J2-3208](https://issues.apache.org/jira/browse/LOG4J2-3208) - Disable `JNDI` by default. The `log4j2.enableJndi` system property must be set to true to allow `JNDI`.</li><li>[Bug Fixed - LOG4J2-3211](https://issues.apache.org/jira/browse/LOG4J2-3211) - Completely remove support for Message Lookups.</li><li>[CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228) and [CVE-2021-45046](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046) addressed in this release by removing message lookup substitution features</li></ul>|
| 2021-12-14 | [CVE-2021-45046 is published](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046) | <ul><li>It was found that the fix to address [CVE-2021-44228](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228) in `Log4j 2.15.0` was incomplete in certain non-default configurations.</li><li>When the logging configuration uses a `non-default Pattern Layout` with a `Context Lookup`  (for example, `$${ctx:loginId}`), an attacker can craft malicious input data using a `JNDI` Lookup pattern, resulting in an information leak and remote code execution.</li><li>Users are advised not to enable JNDI in Log4j 2.16.0. If the JMS Appender is required, use Log4j 2.12.2.</li><li>**Log4j 1.x is not impacted by this vulnerability**.</li><li>**Only the `log4j-core` JAR file is impacted by this vulnerability.**</li><li>**Only Pattern Layouts with a Context Lookup (for example, `$${ctx:loginId}`) are vulnerable to this**.</li><li>**Lookups in configuration still work**.</li><li>**JNDI lookups in configuration now need to be enabled explicitly**.</li></ul>|
| 2021-12-15 | [LOG4J2-3230](https://issues.apache.org/jira/browse/LOG4J2-3230) | <ul><li>An issue was created to report that if a string substitution is attempted for any reason on the following string, it will trigger an infinite recursion, and the application will crash: `${${::-${::-$${::-j}}}}`.</li></ul> |
| 2021-12-16| [CVE-2021-45105 published](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45105) | <ul><li>Log4j2 versions 2.0-alpha1 through 2.16.0 (excluding 2.12.3) did not protect from uncontrolled recursion from self-referential lookups. This allows an attacker with control over Thread Context Map data to cause a denial of service when a crafted string is interpreted.</li><li>Based on [an article](https://www.zerodayinitiative.com/blog/2021/12/17/cve-2021-45105-denial-of-service-via-uncontrolled-recursion-in-log4j-strsubstitutor) from the [Zero Day Initiative](https://www.zerodayinitiative.com/), when a nested variable is substituted by the [StrSubstitutor class](https://logging.apache.org/log4j/2.x/log4j-core/apidocs/org/apache/logging/log4j/core/lookup/StrSubstitutor.html), it recursively calls the `substitute()` class. However, when the nested variable references the variable being replaced, the `recursion` is called with the `same string`. This leads to an infinite recursion and a DoS condition on the server. As an example, if the Pattern Layout contains a Context Lookup of `${ctx.apiversion}`, and its assigned value is `${${ctx.apiversion}}`, the variable will be recursively substituted with itself.</li><li>**Log4j 1.x is not impacted by this vulnerability**.</li><li>**Only the log4j-core JAR file is impacted by this vulnerability**.</li></ul>|
| 2021 -12-16 | [LOG4J2-3242](https://issues.apache.org/jira/browse/LOG4J2-3242) | <ul><li>An issue was created to limit JNDI to the java protocol only</li><li>JNDI enablement property was renamed/extended from `log4j2.enableJndi` to `log4j2.enableJndiLookup`, `log4j2.enableJndiJms`, and `log4j2.enableJndiContextSelector`.</li><li>Limit JNDI to the java protocol only. The enablement property has been renamed to `log4j2.enableJndiJava'.</li></ul>|
| 2021-12-18 | [Log4j 2.17.0 released!](https://logging.apache.org/log4j/2.x/changes-report.html#a2.17.0) | <ul><li>[Bug Fixed - LOG4J2-3230](https://issues.apache.org/jira/browse/LOG4J2-3230) Fixed string substitution recursion. This addresses [CVE-2021-45105](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45105)</li><li>[Big Fixed - LOG4J2-3242](https://issues.apache.org/jira/browse/LOG4J2-3242) Limit JNDI to the java protocol only. JNDI will remain disabled by default. JNDI enablement property `log4j2.enableJndi` renamed.</li><li>[Big Fixed - LOG4J2-3242](https://issues.apache.org/jira/browse/LOG4J2-3242) Limit JNDI to the java protocol only. The enablement property has been renamed to 'log4j2.enableJndiJava'. Fixes LOG4J2-3242</li><li>JNDI will remain disabled by default.</li></ul>|


# References
* https://logging.apache.org/log4j/2.x/manual/index.html
* https://www.cisa.gov/uscert/ncas/current-activity/2021/12/13/cisa-creates-webpage-apache-log4j-vulnerability-cve-2021-44228
* https://blogs.apache.org/logging/entry/apache_log4j_2_0_beta9
* https://issues.apache.org/jira/browse/LOG4J2-313
* https://logging.apache.org/log4j/2.x/changes-report.html
* https://www.zerodayinitiative.com/blog/2021/12/17/cve-2021-45105-denial-of-service-via-uncontrolled-recursion-in-log4j-strsubstitutor